# [Component Name]

<!-- Replace [Component Name] with the actual component name, e.g., "Open WebUI", "Authentik", "n8n" -->

## Overview

<!-- Brief 1-2 sentence description of what this component does -->

**Namespace**: `[namespace]`
**URL**: `https://[service].lab.axiomlayer.com` (if applicable)
**Type**: [Application/Infrastructure]

## Purpose

<!-- Detailed description of:
- What problem this component solves
- Why it's needed in the homelab
- How it fits into the overall architecture
-->

## Architecture

```
┌─────────────────────────────────────────┐
│   Component Architecture Diagram        │
│   (Optional - use ASCII art)            │
└─────────────────────────────────────────┘
```

<!-- Describe:
- Dependencies (other components it requires)
- Data flow
- Network connectivity
- Storage requirements
-->

## Components

### Kubernetes Resources

| Resource | Name | Purpose |
|----------|------|---------|
| Namespace | `[namespace]` | Isolates component resources |
| Deployment | `[deployment-name]` | Main application workload |
| Service | `[service-name]` | ClusterIP/LoadBalancer service |
| Ingress | `[ingress-name]` | External access via Traefik |
| Certificate | `[cert-name]` | TLS certificate from Let's Encrypt |
| NetworkPolicy | `[policy-name]` | Network isolation rules |
| PodDisruptionBudget | `[pdb-name]` | HA configuration (if applicable) |

### Additional Resources

<!-- List any additional resources like:
- ConfigMaps
- Secrets/SealedSecrets
- PersistentVolumeClaims
- ServiceAccounts
- RBAC (Roles, RoleBindings)
- Custom Resources (e.g., CNPG Cluster, Authentik Outpost)
-->

## Configuration

### Environment Variables

<!-- If component uses environment variables via ConfigMap or Secret -->

| Variable | Source | Purpose | Example |
|----------|--------|---------|---------|
| `VAR_NAME` | ConfigMap/SealedSecret | Description | `value` |

### ConfigMap

<!-- Describe any ConfigMaps and their purpose -->

**File**: `configmap.yaml`

```yaml
# Example snippet
data:
  key: value
```

### Sealed Secrets

<!-- List any secrets used by the component -->

**File**: `sealed-secret.yaml`

| Secret Key | Purpose | How to Generate |
|------------|---------|-----------------|
| `api-key` | API access | `openssl rand -base64 32` |
| `db-password` | Database password | Generated by operator |

**Creating the sealed secret**:
```bash
kubectl create secret generic [component]-secret \
  --namespace [namespace] \
  --from-literal=key=value \
  --dry-run=client -o yaml | \
  kubeseal --format yaml > sealed-secret.yaml
```

## Database

<!-- If component uses a database -->

**Type**: PostgreSQL (CloudNativePG) / SQLite / Redis / etc.

**Cluster Name**: `[db-cluster-name]`
**Service**: `[db-cluster-name]-rw.[namespace].svc:5432`

### Schema

<!-- Brief description of database schema/structure if relevant -->

### Backups

**Backed Up**: Yes/No
**Backup Schedule**: [If backed up, describe schedule]
**Retention**: [Retention policy]

## Networking

### Ingress Configuration

**Host**: `[service].lab.axiomlayer.com`
**TLS**: Yes (Let's Encrypt via cert-manager)
**Authentication**: [Forward Auth / Native OIDC / None]

```yaml
# Key ingress annotations
traefik.ingress.kubernetes.io/router.middlewares: authentik-ak-outpost-forward-auth-outpost@kubernetescrd
```

### Network Policies

**Default Policy**: Deny all ingress and egress

**Allowed Ingress**:
- From Traefik (kube-system namespace)
- [Other allowed sources]

**Allowed Egress**:
- To DNS (kube-system/kube-dns)
- To [database/other services]
- To Internet (if needed for external APIs)

## Authentication & Authorization

<!-- If component uses auth -->

**Auth Method**: Forward Auth / Native OIDC / None

### Forward Auth

Authentik forward auth via Traefik middleware:
- User headers: `X-Authentik-Username`, `X-Authentik-Email`, `X-Authentik-Groups`
- Configured in Authentik: [Provider name]
- Outpost: `forward-auth-outpost`

### Native OIDC

<!-- If using native OIDC integration -->

**Provider**: [Authentik provider name]
**Client ID**: Stored in SealedSecret
**Client Secret**: Stored in SealedSecret
**Scopes**: openid, email, profile, [others]
**Redirect URI**: `https://[service].lab.axiomlayer.com/auth/callback`

**Authentik Configuration**:
1. Provider Type: OAuth2/OpenID
2. Scope Mappings: openid, email, profile
3. Application: [Application name]

## Storage

<!-- If component uses persistent storage -->

**StorageClass**: `longhorn`
**Access Mode**: ReadWriteOnce / ReadWriteMany
**Size**: [Size]

**Volumes**:
| PVC Name | Mount Path | Purpose |
|----------|------------|---------|
| `[pvc-name]` | `/data` | Application data |

## Monitoring

### Metrics

**ServiceMonitor**: Yes/No

**Metrics Endpoint**: `http://[service]:[port]/metrics`

**Key Metrics**:
- `[metric_name]` - Description
- `[metric_name]` - Description

### Logs

**Log Collection**: Promtail → Loki

**Log Format**: JSON / Plain Text

**Key Log Patterns**:
- `[pattern]` - Indicates [condition]

### Alerts

<!-- If component has specific alerts configured -->

| Alert | Severity | Description |
|-------|----------|-------------|
| `[AlertName]` | critical/warning | Alert description |

**Alert Rules**: `infrastructure/alertmanager/prometheus-rules.yaml`

## Operations

### Deployment

**ArgoCD Application**: `apps/argocd/applications/[component].yaml`

```bash
# Manual sync (if needed)
argocd app sync [component]

# Or via kubectl
kubectl patch application [component] -n argocd --type=merge \
  -p '{"operation":{"sync":{}}}'
```

### Scaling

```bash
# Scale deployment
kubectl scale deployment [deployment-name] -n [namespace] --replicas=3

# Check scaling
kubectl get pods -n [namespace]
```

### Restarting

```bash
# Restart deployment
kubectl rollout restart deployment/[deployment-name] -n [namespace]

# Watch restart
kubectl rollout status deployment/[deployment-name] -n [namespace]
```

### Accessing Logs

```bash
# View logs
kubectl logs -n [namespace] deployment/[deployment-name] --tail=100 --follow

# View logs from all replicas
kubectl logs -n [namespace] -l app.kubernetes.io/name=[component] --tail=100 --follow
```

### Accessing Shell

```bash
# Get a shell in the pod
kubectl exec -it -n [namespace] deployment/[deployment-name] -- /bin/sh

# Or bash if available
kubectl exec -it -n [namespace] deployment/[deployment-name] -- /bin/bash
```

### Database Access

<!-- If component has a database -->

```bash
# Access database
kubectl exec -it -n [namespace] [db-cluster-name]-1 -- psql -U [username] -d [database]

# Backup database (manual)
kubectl exec -n [namespace] [db-cluster-name]-1 -- \
  pg_dump -U [username] [database] > backup-$(date +%Y%m%d).sql

# Restore database
kubectl exec -i -n [namespace] [db-cluster-name]-1 -- \
  psql -U [username] -d [database] < backup.sql
```

## Troubleshooting

### Common Issues

#### Issue 1: [Common problem]

**Symptoms**:
- [What you see]

**Cause**:
- [Why it happens]

**Solution**:
```bash
# Commands to fix
kubectl [command]
```

#### Issue 2: [Another common problem]

**Symptoms**:
- [What you see]

**Cause**:
- [Why it happens]

**Solution**:
```bash
# Commands to fix
kubectl [command]
```

### Health Checks

```bash
# Check pod status
kubectl get pods -n [namespace]

# Check pod events
kubectl describe pod -n [namespace] [pod-name]

# Check service endpoints
kubectl get endpoints -n [namespace]

# Check ingress
kubectl get ingress -n [namespace]

# Check certificate
kubectl get certificate -n [namespace]
```

### Debug Mode

<!-- If component supports debug mode -->

```yaml
# Add to deployment
env:
  - name: DEBUG
    value: "true"
  - name: LOG_LEVEL
    value: "debug"
```

## Upgrade Procedure

1. **Check current version**:
   ```bash
   kubectl get deployment [deployment-name] -n [namespace] -o jsonpath='{.spec.template.spec.containers[0].image}'
   ```

2. **Update image version** in `deployment.yaml`:
   ```yaml
   image: [registry]/[image]:[new-version]
   ```

3. **Commit and push** - ArgoCD will sync automatically

4. **Watch rollout**:
   ```bash
   kubectl rollout status deployment/[deployment-name] -n [namespace]
   ```

5. **Verify functionality**: Test application endpoints and functionality

6. **Rollback if needed**:
   ```bash
   kubectl rollout undo deployment/[deployment-name] -n [namespace]
   ```

## Backup and Restore

<!-- If component requires backups beyond automated database backups -->

### Backup

```bash
# Backup command
[backup commands]
```

### Restore

```bash
# Restore command
[restore commands]
```

## Security Considerations

- **Run as non-root**: `runAsNonRoot: true`, `runAsUser: 1000`
- **Read-only root filesystem**: `readOnlyRootFilesystem: true` (where possible)
- **Drop all capabilities**: `capabilities: drop: ["ALL"]`
- **Network policies**: Default deny with explicit allows
- **Secrets management**: All secrets via SealedSecrets
- **TLS**: All external communication via HTTPS
- **Authentication**: [Auth method] protects access

## Performance Tuning

<!-- If applicable -->

### Resource Limits

**Current Settings**:
```yaml
resources:
  requests:
    cpu: [value]
    memory: [value]
  limits:
    cpu: [value]
    memory: [value]
```

**Recommended Settings**:
- For low traffic: [recommendations]
- For medium traffic: [recommendations]
- For high traffic: [recommendations]

### Replicas

**Current**: 1-3 replicas (based on load)
**HA Configuration**: PodDisruptionBudget ensures minimum availability

## Related Documentation

- [Link to external documentation if applicable]
- `docs/TROUBLESHOOTING.md` - General troubleshooting
- `CLAUDE.md` - Operator guide
- `CONTRIBUTING.md` - Contributing guidelines

## Maintainer Notes

<!-- Internal notes for maintainers -->

- Last reviewed: [Date]
- Known issues: [Any known issues or limitations]
- Future improvements: [Planned enhancements]
