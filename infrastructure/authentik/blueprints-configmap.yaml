apiVersion: v1
kind: ConfigMap
metadata:
  name: authentik-blueprints
  namespace: authentik
  labels:
    app.kubernetes.io/name: authentik
    app.kubernetes.io/component: blueprints
    app.kubernetes.io/part-of: homelab
    app.kubernetes.io/managed-by: argocd
data:
  homelab-apps.yaml: |
    # Authentik Blueprint for Homelab Applications
    # Each application has its own provider for proper isolation
    version: 1
    metadata:
      name: Homelab Applications
      labels:
        blueprints.goauthentik.io/description: "All homelab application definitions"
    entries:
      # ===================
      # User Groups
      # ===================
      - model: authentik_core.group
        id: group-admins
        identifiers:
          name: Homelab Admins
        attrs:
          is_superuser: false

      - model: authentik_core.group
        id: group-users
        identifiers:
          name: Homelab Users
        attrs:
          is_superuser: false

      # ===================
      # Users
      # ===================
      - model: authentik_core.user
        id: user-jasen
        identifiers:
          username: jasen
        attrs:
          name: Jasen
          email: jasen@axiomlayer.com
          is_active: true
          groups:
            - !KeyOf group-admins
            - !KeyOf group-users

      # ===================
      # Proxy Providers (Forward Auth - one per app)
      # ===================
      - model: authentik_providers_proxy.proxyprovider
        id: provider-dashboard
        identifiers:
          name: Dashboard Proxy Provider
        attrs:
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          mode: forward_single
          external_host: https://db.lab.axiomlayer.com

      - model: authentik_providers_proxy.proxyprovider
        id: provider-n8n
        identifiers:
          name: n8n Proxy Provider
        attrs:
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          mode: forward_single
          external_host: https://autom8.lab.axiomlayer.com

      - model: authentik_providers_proxy.proxyprovider
        id: provider-open-webui
        identifiers:
          name: Open WebUI Proxy Provider
        attrs:
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          mode: forward_single
          external_host: https://ai.lab.axiomlayer.com

      - model: authentik_providers_proxy.proxyprovider
        id: provider-campfire
        identifiers:
          name: Campfire Proxy Provider
        attrs:
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          mode: forward_single
          external_host: https://chat.lab.axiomlayer.com

      - model: authentik_providers_proxy.proxyprovider
        id: provider-alertmanager
        identifiers:
          name: Alertmanager Proxy Provider
        attrs:
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          mode: forward_single
          external_host: https://alerts.lab.axiomlayer.com

      - model: authentik_providers_proxy.proxyprovider
        id: provider-longhorn
        identifiers:
          name: Longhorn Proxy Provider
        attrs:
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          mode: forward_single
          external_host: https://longhorn.lab.axiomlayer.com

      - model: authentik_providers_proxy.proxyprovider
        id: provider-telnet
        identifiers:
          name: Telnet Server Proxy Provider
        attrs:
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          mode: forward_single
          external_host: https://telnet.lab.axiomlayer.com

      # ===================
      # OIDC Providers (Native SSO)
      # ===================
      - model: authentik_providers_oauth2.oauth2provider
        id: provider-argocd
        identifiers:
          name: ArgoCD OIDC Provider
        attrs:
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          client_type: confidential
          client_id: argocd
          client_secret: "11190a6436c58bfdce05e788c52d38d9a56db18d17417d8b1f31f161b6be622a"
          redirect_uris:
            - matching_mode: strict
              url: https://argocd.lab.axiomlayer.com/api/dex/callback
          access_token_validity: hours=1
          refresh_token_validity: days=30
          include_claims_in_id_token: true
          sub_mode: user_email
          signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Self-signed Certificate]]

      - model: authentik_providers_oauth2.oauth2provider
        id: provider-grafana
        identifiers:
          name: Grafana OAuth2 Provider
        attrs:
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          client_type: confidential
          client_id: grafana
          client_secret: "b023d23d0199ab3e85ccb1a31dd861ca0e45cebbc8ae5cd992bd93643a4df409"
          redirect_uris:
            - matching_mode: strict
              url: https://grafana.lab.axiomlayer.com/login/generic_oauth
          access_token_validity: hours=1
          refresh_token_validity: days=30
          include_claims_in_id_token: true
          sub_mode: user_email
          signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Self-signed Certificate]]

      - model: authentik_providers_oauth2.oauth2provider
        id: provider-outline
        identifiers:
          name: Outline OIDC Provider
        attrs:
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          client_type: confidential
          client_id: outline
          client_secret: "585d48f4a5e90c66d467c581766f05c13c7fa440e5172b95a144a6bdac232c6b"
          redirect_uris:
            - matching_mode: strict
              url: https://docs.lab.axiomlayer.com/auth/oidc.callback
          access_token_validity: hours=1
          refresh_token_validity: days=30
          include_claims_in_id_token: true
          sub_mode: user_email
          signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Self-signed Certificate]]

      - model: authentik_providers_oauth2.oauth2provider
        id: provider-plane
        identifiers:
          name: Plane OIDC Provider
        attrs:
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          client_type: confidential
          client_id: plane
          client_secret: "plane-oidc-secret-change-me"
          redirect_uris:
            - matching_mode: strict
              url: https://plane.lab.axiomlayer.com/auth/oidc/callback/
          access_token_validity: hours=1
          refresh_token_validity: days=30
          include_claims_in_id_token: true
          sub_mode: user_email
          signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Self-signed Certificate]]

      # ===================
      # Kubernetes Service Connection (for outpost deployment)
      # ===================
      - model: authentik_outposts.kubernetesserviceconnection
        id: k8s-local
        identifiers:
          name: Local Kubernetes
        attrs:
          local: true
          verify_ssl: true

      # ===================
      # Outpost (Forward Auth)
      # ===================
      - model: authentik_outposts.outpost
        id: outpost-forward-auth
        identifiers:
          name: forward-auth-outpost
        attrs:
          type: proxy
          service_connection: !KeyOf k8s-local
          providers:
            - !KeyOf provider-dashboard
            - !KeyOf provider-n8n
            - !KeyOf provider-open-webui
            - !KeyOf provider-campfire
            - !KeyOf provider-alertmanager
            - !KeyOf provider-longhorn
            - !KeyOf provider-telnet
          config:
            authentik_host: https://auth.lab.axiomlayer.com
            docker_labels: null
            docker_map_ports: true
            docker_network: null
            container_image: null
            kubernetes_replicas: 1
            kubernetes_namespace: authentik
            kubernetes_ingress_annotations:
              traefik.ingress.kubernetes.io/router.entrypoints: websecure
            kubernetes_ingress_secret_name: ak-outpost-forward-auth-tls
            kubernetes_service_type: ClusterIP
            object_naming_template: ak-outpost-%(name)s

      # ===================
      # Applications - Platform
      # ===================
      - model: authentik_core.application
        id: app-dashboard
        identifiers:
          slug: dashboard
        attrs:
          name: Dashboard
          provider: !KeyOf provider-dashboard
          meta_launch_url: https://db.lab.axiomlayer.com
          meta_icon: https://cdn-icons-png.flaticon.com/512/1828/1828765.png
          meta_description: Homelab service dashboard
          policy_engine_mode: any
          group: Platform

      - model: authentik_core.application
        id: app-argocd
        identifiers:
          slug: argocd
        attrs:
          name: ArgoCD
          provider: !KeyOf provider-argocd
          meta_launch_url: https://argocd.lab.axiomlayer.com
          meta_icon: https://argo-cd.readthedocs.io/en/stable/assets/logo.png
          meta_description: GitOps continuous delivery
          policy_engine_mode: any
          group: Platform

      - model: authentik_core.application
        id: app-authentik
        identifiers:
          slug: authentik
        attrs:
          name: Authentik
          meta_launch_url: https://auth.lab.axiomlayer.com
          meta_icon: https://goauthentik.io/img/icon.png
          meta_description: Identity provider and SSO
          policy_engine_mode: any
          group: Platform

      # ===================
      # Applications - Apps
      # ===================
      - model: authentik_core.application
        id: app-plane
        identifiers:
          slug: plane
        attrs:
          name: Plane
          provider: !KeyOf provider-plane
          meta_launch_url: https://plane.lab.axiomlayer.com
          meta_icon: https://plane.so/favicon.ico
          meta_description: Project management and issue tracking
          policy_engine_mode: any
          group: Applications

      - model: authentik_core.application
        id: app-outline
        identifiers:
          slug: outline
        attrs:
          name: Outline
          provider: !KeyOf provider-outline
          meta_launch_url: https://docs.lab.axiomlayer.com
          meta_icon: https://www.getoutline.com/images/favicon.png
          meta_description: Documentation and knowledge base
          policy_engine_mode: any
          group: Applications

      - model: authentik_core.application
        id: app-n8n
        identifiers:
          slug: n8n
        attrs:
          name: n8n (autom8)
          provider: !KeyOf provider-n8n
          meta_launch_url: https://autom8.lab.axiomlayer.com
          meta_icon: https://n8n.io/favicon.ico
          meta_description: Workflow automation platform
          policy_engine_mode: any
          group: Applications

      - model: authentik_core.application
        id: app-open-webui
        identifiers:
          slug: open-webui
        attrs:
          name: Open WebUI
          provider: !KeyOf provider-open-webui
          meta_launch_url: https://ai.lab.axiomlayer.com
          meta_icon: https://openwebui.com/favicon.png
          meta_description: AI chat interface
          policy_engine_mode: any
          group: Applications

      - model: authentik_core.application
        id: app-campfire
        identifiers:
          slug: campfire
        attrs:
          name: Campfire
          provider: !KeyOf provider-campfire
          meta_launch_url: https://chat.lab.axiomlayer.com
          meta_icon: https://cdn-icons-png.flaticon.com/512/2991/2991148.png
          meta_description: Team chat and communication
          policy_engine_mode: any
          group: Applications

      # ===================
      # Applications - Observability
      # ===================
      - model: authentik_core.application
        id: app-grafana
        identifiers:
          slug: grafana
        attrs:
          name: Grafana
          provider: !KeyOf provider-grafana
          meta_launch_url: https://grafana.lab.axiomlayer.com
          meta_icon: https://grafana.com/static/assets/img/fav32.png
          meta_description: Metrics dashboards and visualization
          policy_engine_mode: any
          group: Observability

      - model: authentik_core.application
        id: app-alertmanager
        identifiers:
          slug: alertmanager
        attrs:
          name: Alertmanager
          provider: !KeyOf provider-alertmanager
          meta_launch_url: https://alerts.lab.axiomlayer.com
          meta_icon: https://prometheus.io/assets/favicons/favicon.ico
          meta_description: Alert management and routing
          policy_engine_mode: any
          group: Observability

      # ===================
      # Applications - Infrastructure
      # ===================
      - model: authentik_core.application
        id: app-longhorn
        identifiers:
          slug: longhorn
        attrs:
          name: Longhorn
          provider: !KeyOf provider-longhorn
          meta_launch_url: https://longhorn.lab.axiomlayer.com
          meta_icon: https://longhorn.io/img/logos/longhorn-icon-color.png
          meta_description: Distributed storage management
          policy_engine_mode: any
          group: Infrastructure

      - model: authentik_core.application
        id: app-telnet
        identifiers:
          slug: telnet-server
        attrs:
          name: Telnet Server
          provider: !KeyOf provider-telnet
          meta_launch_url: https://telnet.lab.axiomlayer.com
          meta_icon: https://cdn-icons-png.flaticon.com/512/900/900618.png
          meta_description: Demo application with SSO
          policy_engine_mode: any
          group: Infrastructure

      # ===================
      # Access Policies
      # ===================
      - model: authentik_policies_expression.expressionpolicy
        id: policy-is-admin
        identifiers:
          name: Is Homelab Admin
        attrs:
          expression: |
            return ak_is_group_member(request.user, name="Homelab Admins")

      - model: authentik_policies_expression.expressionpolicy
        id: policy-is-user
        identifiers:
          name: Is Homelab User
        attrs:
          expression: |
            return ak_is_group_member(request.user, name="Homelab Admins") or ak_is_group_member(request.user, name="Homelab Users")

      # ===================
      # Policy Bindings - ArgoCD (Admin only)
      # ===================
      - model: authentik_policies.policybinding
        id: binding-argocd-admin
        identifiers:
          order: 0
          target: !KeyOf app-argocd
          policy: !KeyOf policy-is-admin
        attrs:
          enabled: true
          timeout: 30

      # ===================
      # Policy Bindings - Grafana (All users)
      # ===================
      - model: authentik_policies.policybinding
        id: binding-grafana-user
        identifiers:
          order: 0
          target: !KeyOf app-grafana
          policy: !KeyOf policy-is-user
        attrs:
          enabled: true
          timeout: 30

      # ===================
      # Policy Bindings - Plane (All users)
      # ===================
      - model: authentik_policies.policybinding
        id: binding-plane-user
        identifiers:
          order: 0
          target: !KeyOf app-plane
          policy: !KeyOf policy-is-user
        attrs:
          enabled: true
          timeout: 30
