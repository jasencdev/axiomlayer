name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Cancel in-progress runs when new commits are pushed
# Prevents CI pileup from rapid Copilot suggestion commits
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  statuses: write

jobs:
  validate-manifests:
    name: Validate Manifests
    runs-on: [self-hosted, homelab]
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install kubectl
        run: |
          if ! command -v kubectl &> /dev/null; then
            ARCH=$(uname -m)
            case $ARCH in
              x86_64) ARCH="amd64" ;;
              aarch64) ARCH="arm64" ;;
              armv7l) ARCH="arm" ;;
            esac
            OS=$(uname -s)
            case $OS in
              Linux) OS="linux" ;;
              Darwin) OS="darwin" ;;
              *) echo "Unsupported OS: $OS"; exit 1 ;;
            esac
            curl -fsSLo kubectl "https://dl.k8s.io/release/$(curl -fsSL https://dl.k8s.io/release/stable.txt)/bin/${OS}/${ARCH}/kubectl"
            chmod +x kubectl
            sudo mv kubectl /usr/local/bin/
          fi
          kubectl version --client

      - name: Validate kustomizations
        run: ./tests/validate-manifests.sh

  lint:
    name: Kubernetes Linting
    runs-on: [self-hosted, homelab]
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install kube-linter
        run: |
          if ! command -v kube-linter &> /dev/null; then
            ARCH=$(uname -m)
            case $ARCH in
              x86_64) TARBALL="kube-linter-linux.tar.gz" ;;
              aarch64) TARBALL="kube-linter-linux_arm64.tar.gz" ;;
              *) echo "Unsupported architecture: $ARCH"; exit 1 ;;
            esac
            curl -sSL -o /tmp/kube-linter.tar.gz "https://github.com/stackrox/kube-linter/releases/download/v0.7.6/${TARBALL}"
            tar -xzf /tmp/kube-linter.tar.gz -C /tmp
            sudo mv /tmp/kube-linter /usr/local/bin/
            rm /tmp/kube-linter.tar.gz
          fi
          kube-linter version

      - name: Lint apps
        run: kube-linter lint apps/ --config .kube-linter.yaml || true

      - name: Lint infrastructure
        run: kube-linter lint infrastructure/ --config .kube-linter.yaml || true

  polaris:
    name: Polaris Audit
    runs-on: [self-hosted, homelab]
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install kubectl
        run: |
          if ! command -v kubectl &> /dev/null; then
            ARCH=$(uname -m)
            case $ARCH in
              x86_64) ARCH="amd64" ;;
              aarch64) ARCH="arm64" ;;
              armv7l) ARCH="arm" ;;
            esac
            OS=$(uname -s)
            case $OS in
              Linux) OS="linux" ;;
              Darwin) OS="darwin" ;;
              *) echo "Unsupported OS: $OS"; exit 1 ;;
            esac
            curl -fsSLo kubectl "https://dl.k8s.io/release/$(curl -fsSL https://dl.k8s.io/release/stable.txt)/bin/${OS}/${ARCH}/kubectl"
            chmod +x kubectl
            sudo mv kubectl /usr/local/bin/
          fi
          kubectl version --client

      - name: Install Polaris
        run: |
          if ! command -v polaris &> /dev/null; then
            ARCH=$(uname -m)
            case $ARCH in
              x86_64) ARCH="amd64" ;;
              aarch64) ARCH="arm64" ;;
              *) echo "Unsupported architecture: $ARCH"; exit 1 ;;
            esac
            POLARIS_VERSION="9.6.1"
            curl -sSL -o /tmp/polaris.tar.gz "https://github.com/FairwindsOps/polaris/releases/download/${POLARIS_VERSION}/polaris_linux_${ARCH}.tar.gz"
            tar -xzf /tmp/polaris.tar.gz -C /tmp
            sudo mv /tmp/polaris /usr/local/bin/
            rm /tmp/polaris.tar.gz
          fi
          polaris version

      - name: Build kustomize manifests
        run: |
          mkdir -p /tmp/rendered-manifests
          for dir in apps/*/; do
            app=$(basename "$dir")
            if [ -f "${dir}kustomization.yaml" ]; then
              kubectl kustomize "$dir" > "/tmp/rendered-manifests/${app}.yaml" 2>/dev/null || true
            fi
          done
          for dir in infrastructure/*/; do
            infra=$(basename "$dir")
            if [ -f "${dir}kustomization.yaml" ]; then
              kubectl kustomize "$dir" > "/tmp/rendered-manifests/${infra}.yaml" 2>/dev/null || true
            fi
          done

      - name: Run Polaris audit
        run: |
          # Run polaris on rendered manifests
          polaris audit --audit-path /tmp/rendered-manifests \
            --format pretty \
            --set-exit-code-below-score 60 || true

          # Also output score summary
          echo ""
          echo "=== Polaris Score Summary ==="
          polaris audit --audit-path /tmp/rendered-manifests \
            --format score 2>/dev/null || echo "Score calculation failed"

  security:
    name: Security Scanning
    runs-on: [self-hosted, homelab]
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Trivy
        run: |
          if ! command -v trivy &> /dev/null; then
            curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin v0.58.0
          fi
          trivy version

      - name: Scan for misconfigurations
        run: trivy config . --severity HIGH,CRITICAL --exit-code 0

      - name: Scan for secrets
        run: trivy fs . --scanners secret --exit-code 1

      - name: Check for plaintext secrets
        run: |
          echo "Checking for plaintext Secret resources (should use SealedSecret)..."
          if grep -rn '^kind: Secret$' --include="*.yaml" apps/ infrastructure/ | grep -v "SealedSecret" | grep -v "kind: SealedSecret"; then
            echo "ERROR: Found plaintext Secret. Use SealedSecret instead."
            exit 1
          fi
          echo "No plaintext secrets found"

  # Gate job - only passes when all CI checks pass
  ci-passed:
    name: CI Passed
    runs-on: [self-hosted, homelab]
    needs: [validate-manifests, lint, polaris, security]
    if: always()
    steps:
      - name: Check CI results
        run: |
          # On PRs, validate-manifests and security must pass
          # On main push, these jobs are skipped (already validated in PR)
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            if [ "${{ needs.validate-manifests.result }}" != "success" ]; then
              echo "Manifest validation failed"
              exit 1
            fi
            if [ "${{ needs.security.result }}" != "success" ]; then
              echo "Security scan failed"
              exit 1
            fi
            # Lint is informational only
            echo "All required CI checks passed"
          else
            echo "Main push - validation already done in PR"
          fi

      - name: Trigger ArgoCD sync
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        env:
          ARGOCD_SERVER: argocd.lab.axiomlayer.com
          ARGOCD_AUTH_TOKEN: ${{ secrets.ARGOCD_AUTH_TOKEN }}
        run: |
          if [ -z "$ARGOCD_AUTH_TOKEN" ]; then
            echo "ARGOCD_AUTH_TOKEN not set, skipping sync trigger"
            exit 0
          fi

          # Trigger sync for the root application (app of apps)
          curl -sSL -X POST \
            -H "Authorization: Bearer $ARGOCD_AUTH_TOKEN" \
            -H "Content-Type: application/json" \
            "https://${ARGOCD_SERVER}/api/v1/applications/applications/sync" \
            -d '{"prune": true}' || echo "Sync trigger sent (may require manual approval)"

  # Post-deployment tests - run after ArgoCD sync
  integration-tests:
    name: Integration Tests
    runs-on: [self-hosted, homelab]
    needs: [ci-passed]
    if: always() && needs.ci-passed.result == 'success' && ((github.ref == 'refs/heads/main' && github.event_name == 'push') || github.event_name == 'workflow_dispatch')
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install kubectl
        run: |
          if ! command -v kubectl &> /dev/null; then
            ARCH=$(uname -m)
            case $ARCH in
              x86_64) ARCH="amd64" ;;
              aarch64) ARCH="arm64" ;;
              armv7l) ARCH="arm" ;;
            esac
            OS=$(uname -s)
            case $OS in
              Linux) OS="linux" ;;
              Darwin) OS="darwin" ;;
              *) echo "Unsupported OS: $OS"; exit 1 ;;
            esac
            curl -fsSLo kubectl "https://dl.k8s.io/release/$(curl -fsSL https://dl.k8s.io/release/stable.txt)/bin/${OS}/${ARCH}/kubectl"
            chmod +x kubectl
            sudo mv kubectl /usr/local/bin/
          fi
          kubectl version --client

      - name: Run smoke tests
        run: ./tests/smoke-test.sh

      - name: Run auth tests
        run: ./tests/test-auth.sh

      - name: Run application functionality tests
        run: ./tests/test-app-functionality.sh

      - name: Run monitoring tests
        run: ./tests/test-monitoring.sh

  # Popeye cluster scan - runs on main push to check cluster health score
  popeye-scan:
    name: Popeye Cluster Scan
    runs-on: [self-hosted, homelab]
    needs: [ci-passed]
    if: always() && needs.ci-passed.result == 'success' && ((github.ref == 'refs/heads/main' && github.event_name == 'push') || github.event_name == 'workflow_dispatch')
    steps:
      - name: Install popeye
        run: |
          if ! command -v popeye &> /dev/null; then
            ARCH=$(uname -m)
            case $ARCH in
              x86_64) ARCH="amd64" ;;
              aarch64) ARCH="arm64" ;;
              *) echo "Unsupported architecture: $ARCH"; exit 1 ;;
            esac
            POPEYE_VERSION="0.21.3"
            curl -sSL -o /tmp/popeye.tar.gz "https://github.com/derailed/popeye/releases/download/v${POPEYE_VERSION}/popeye_Linux_${ARCH}.tar.gz"
            tar -xzf /tmp/popeye.tar.gz -C /tmp
            sudo mv /tmp/popeye /usr/local/bin/
            rm /tmp/popeye.tar.gz
          fi
          popeye version

      - name: Run Popeye scan
        run: |
          # Run popeye and capture score
          popeye --all-namespaces --force-exit-zero -o json > /tmp/popeye-report.json 2>/dev/null || true

          # Extract and display score (popeye JSON structure: .popeye.score)
          SCORE=$(jq -r '.popeye.score // 0' /tmp/popeye-report.json 2>/dev/null || echo "0")
          echo "Cluster health score: ${SCORE}%"

          # Show summary of issues
          echo ""
          echo "=== Issue Summary ==="
          jq -r '.popeye.sanitizers[] | select(.issues != null) | "\(.sanitizer): \(.issues | length) issues"' /tmp/popeye-report.json 2>/dev/null || true

          # Fail if score drops below threshold (currently 75 to allow some wiggle room)
          THRESHOLD=75
          if [ "${SCORE}" -lt "${THRESHOLD}" ]; then
            echo ""
            echo "ERROR: Cluster health score ${SCORE}% is below threshold of ${THRESHOLD}%"
            echo "Run 'popeye --all-namespaces' locally for full report"
            exit 1
          fi

          echo ""
          echo "Cluster health score ${SCORE}% meets threshold of ${THRESHOLD}%"

  # Extended tests - run on main push, schedule, or manual trigger
  extended-tests:
    name: Extended Tests
    runs-on: [self-hosted, homelab]
    needs: [ci-passed]
    if: always() && needs.ci-passed.result == 'success' && ((github.ref == 'refs/heads/main' && github.event_name == 'push') || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule')
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install kubectl
        run: |
          if ! command -v kubectl &> /dev/null; then
            ARCH=$(uname -m)
            case $ARCH in
              x86_64) ARCH="amd64" ;;
              aarch64) ARCH="arm64" ;;
              armv7l) ARCH="arm" ;;
            esac
            OS=$(uname -s)
            case $OS in
              Linux) OS="linux" ;;
              Darwin) OS="darwin" ;;
              *) echo "Unsupported OS: $OS"; exit 1 ;;
            esac
            curl -fsSLo kubectl "https://dl.k8s.io/release/$(curl -fsSL https://dl.k8s.io/release/stable.txt)/bin/${OS}/${ARCH}/kubectl"
            chmod +x kubectl
            sudo mv kubectl /usr/local/bin/
          fi
          kubectl version --client

      - name: Run backup and restore tests
        env:
          RUN_BACKUP_TEST: "true"
          VERIFY_BACKUP_FILES: "true"
        run: ./tests/test-backup-restore.sh

      - name: Run network policy tests
        run: ./tests/test-network-policies.sh

  outline-sync:
    name: Outline Sync
    runs-on: [self-hosted, homelab]
    needs: [ci-passed]
    if: always() && needs.ci-passed.result == 'success' && github.ref == 'refs/heads/main' && github.event_name == 'push'
    env:
      OUTLINE_API_TOKEN: ${{ secrets.OUTLINE_API_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Sync docs to Outline
        run: |
          if [ -z "$OUTLINE_API_TOKEN" ]; then
            echo "OUTLINE_API_TOKEN not set; skipping Outline sync."
            exit 0
          fi
          ./scripts/sync-outline.sh

  rag-sync:
    name: RAG Sync
    runs-on: [self-hosted, homelab]
    needs: [ci-passed]
    if: always() && needs.ci-passed.result == 'success' && github.ref == 'refs/heads/main' && github.event_name == 'push'
    env:
      OPEN_WEBUI_API_KEY: ${{ secrets.OPEN_WEBUI_API_KEY }}
      OPEN_WEBUI_KNOWLEDGE_ID: ${{ secrets.OPEN_WEBUI_KNOWLEDGE_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install kubectl
        run: |
          if ! command -v kubectl &> /dev/null; then
            ARCH=$(uname -m)
            case $ARCH in
              x86_64) ARCH="amd64" ;;
              aarch64) ARCH="arm64" ;;
              armv7l) ARCH="arm" ;;
            esac
            OS=$(uname -s)
            case $OS in
              Linux) OS="linux" ;;
              Darwin) OS="darwin" ;;
              *) echo "Unsupported OS: $OS"; exit 1 ;;
            esac
            curl -fsSLo kubectl "https://dl.k8s.io/release/$(curl -fsSL https://dl.k8s.io/release/stable.txt)/bin/${OS}/${ARCH}/kubectl"
            chmod +x kubectl
            sudo mv kubectl /usr/local/bin/
          fi
          kubectl version --client

      - name: Sync repo to Open WebUI RAG
        run: |
          if [ -z "$OPEN_WEBUI_API_KEY" ]; then
            echo "OPEN_WEBUI_API_KEY not set; skipping RAG sync."
            exit 0
          fi
          if [ -z "$OPEN_WEBUI_KNOWLEDGE_ID" ]; then
            echo "OPEN_WEBUI_KNOWLEDGE_ID not set; skipping RAG sync."
            exit 0
          fi
          ./scripts/sync-rag.sh
